{% load game_extras %}
<!DOCTYPE html>
<html lang="en">

<head>
    <title>NBA Grid - {{ year }} {{ month }} {{ day }}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Play NBAGrid - a daily puzzle game where you find NBA players matching specific criteria. Challenge yourself with {{ month }} {{ day }}, {{ year }}'s grid!">
    <meta name="keywords" content="NBAGrid, basketball game, NBA puzzle, daily game, NBA players, basketball trivia">
    <meta name="author" content="Nils Brinkmann">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.scheme }}://{{ request.get_host }}{{ request.path }}">
    <meta property="og:title" content="NBAGrid - {{ year }} {{ month }} {{ day }}">
    <meta property="og:description" content="Play NBAGrid - a daily puzzle game where you find NBA players matching specific criteria. Challenge yourself with {{ month }} {{ day }}, {{ year }}'s grid!">
    <!--<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}/static/images/nbagrid-og.png">-->
    <meta property="og:site_name" content="NBAGrid">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.scheme }}://{{ request.get_host }}{{ request.path }}">
    <meta property="twitter:title" content="NBAGrid - {{ year }} {{ month }} {{ day }}">
    <meta property="twitter:description" content="Play NBAGrid - a daily puzzle game where you find NBA players matching specific criteria. Challenge yourself with {{ month }} {{ day }}, {{ year }}'s grid!">
    <!--<meta property="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}/static/images/nbagrid-og.png">-->
    
    <!-- Additional SEO -->
    <meta name="theme-color" content="#1d428a">
    <meta name="msapplication-TileColor" content="#1d428a">
    <link rel="canonical" href="{{ request.scheme }}://{{ request.get_host }}{{ request.path }}">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "NBAGrid",
        "description": "A daily puzzle game where you find NBA players matching specific criteria",
        "url": "{{ request.scheme }}://{{ request.get_host }}{{ request.path }}",
        "applicationCategory": "Game",
        "operatingSystem": "Web Browser",
        "author": {
            "@type": "Person",
            "name": "Nils Brinkmann",
            "url": "https://nils.brink.men"
        },
        "datePublished": "{{ year }}-{{ month_num }}-{{ day }}",
        "gameServer": {
            "@type": "GameServer",
            "serverStatus": "Online"
        },
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        }
    }
    </script>
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    {% csrf_token %}
    <style>
        /* Base styles for all screen sizes */
        body {
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }

        .game-container {
            background-color: #000000;
            border-radius: 10px;
            max-width: 1200px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin: 0 auto;
            padding: 15px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 3px;
            max-width: 100%;
            margin: 0 auto;
        }

        .cell {
            background-color: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 14px;
            transition: background-color .3s;
            color: white;
            min-height: 60px;
            word-break: break-word;
            padding: 10px;
            position: relative;
        }

        .cell:not(.header-cell):not(.game-title-cell):not(.correct):hover {
            background-color: #3a3a3a;
            cursor: pointer;
        }

        .game-finished .cell.correct:hover {
            background-color: #567e56 !important;
            cursor: pointer !important;
        }

        .header-cell {
            font-weight: bold;
            font-size: 14px;
            cursor: default;
            color: white;
            margin: 0;
            padding: 15px;
        }

        .header-row {
            background-color: #1d428a;  /* NBA Blue */
        }

        .header-col {
            background-color: #c8102e;  /* NBA Red */
        }

        .correct {
            background-color: #004d00;  /* Green for correct picks */
            color: white;
            cursor: default;
        }

        .wrong-guesses {
            color: #800000;  /* Dark red text */
            font-size: 10px;
            font-weight: bold;
            position: absolute;
            top: 2px;
            left: 2px;
            z-index: 1;
            background-color: #ff8e8e;  /* Bright red background */
            padding: 2px 4px;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .game-title-cell {
            min-height: 70px;
            color: white;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .game-attempts {
            font-size: 14px;
            margin-bottom: 0;
        }

        .game-score {
            font-size: 16px;
            color: white;
        }

        #attempts-remaining {
            color: #1e8a1e;
            font-weight: 700;
        }

        .modal,
        .correct-players-modal,
        .about-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content,
        .correct-players-content,
        .about-content {
            background-color: #2a2a2a;
            width: 90%;
            max-width: 500px;
            color: #FFF;
            margin: 2vh auto;
            padding: 30px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 10px;
        }

        /* Impressum specific styles */
        .impressum-section {
            margin-bottom: 20px;
        }

        .impressum-section h3 {
            color: #FFF;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .impressum-text {
            color: #CCC;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .player-suggestion {
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #3a3a3a;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color .3s;
            margin: 4px 0;
            padding: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .player-suggestion:hover {
            background-color: #4a4a4a;
        }

        .player-suggestion button {
            background-color: #1e3d59;
            color: #FFF;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            padding: 12px 8px;
            white-space: nowrap;
            flex-shrink: 0;
            transition: background-color 0.3s;
        }

        .player-suggestion button:disabled {
            background-color: #666;
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .player-suggestion button:hover:not(:disabled) {
            background-color: #2a4d6e;
        }

        @keyframes flashRed {
            0% { background-color: #4a1e1e; }
            100% { background-color: #2a2a2a; }
        }

        .flash-red {
            animation: flashRed 1s ease-out;
        }

        #player-search {
            font-size: 14px;
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            box-sizing: border-box;
        }

        .exhausted {
            background-color: #4a1e1e !important;
            color: white;
            cursor: pointer;
        }

        .exhausted:hover {
            background-color: #5a2e2e !important;
        }

        .correct-players-content h2 {
            background-color: #2a2a2a;
            margin: 0 0 15px;
            padding: 0;
        }

        #correct-players-list {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 15px;
        }

        .correct-player {
            background-color: #3a3a3a;
            border-radius: 5px;
            margin: 5px 0;
            padding: 10px;
            position: relative;
        }

        .correct-player.wrong-guess {
            background-color: #4a1e1e;
            border-left: 3px solid #800000;
        }

        .correct-player.wrong-guess .player-name {
            color: #ff8e8e;
        }

        .correct-player.wrong-guess .player-stats {
            color: #cc6666;
        }

        .wrong-guess-count {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            font-weight: bold;
            color: #800000;
            background-color: #ff8e8e;
            padding: 2px 4px;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .player-name {
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .player-stats {
            font-size: 12px;
            color: #888;
            line-height: 1.4;
        }

        .player-stats br {
            display: block;
            content: "";
            margin: 2px 0;
        }

        .correct-players-content button {
            background-color: #1e3d59;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            padding: 10px 20px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 20px 20px;
            position: relative;
        }

        .help-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #1d428a;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            z-index: 10;
        }

        .support-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: #1d428a;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            z-index: 10;
        }

        .help-button:hover {
            background-color: #2a4d6e;
        }

        .support-button:hover {
            background-color: #2a4d6e;
        }

        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .help-content {
            background-color: #2a2a2a;
            width: 90%;
            max-width: 500px;
            color: #FFF;
            margin: 5% auto;
            padding: 30px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 10px;
        }

        .help-content h2 {
            color: white;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .help-content p {
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 16px;
        }

        .help-content ul {
            margin-bottom: 20px;
            padding-left: 20px;
        }

        .help-content li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .help-content .btn {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .game-title-large {
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin-bottom: 0;
        }
        .game-subtitle {
            font-size: 10px;
            font-style: italic;
            color: #888;
            display: none;
        }

        .game-title {
            text-align: center;
            font-size: 20px;
            color: #888;
            margin: 10px 0;
            font-style: italic;
        }

        .date-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 0px;
        }

        .nav-arrow {
            font-size: 20px;
            color: white;
            text-decoration: none;
            cursor: pointer;
            opacity: 0.5;
        }

        .nav-arrow:hover {
            opacity: 1;
        }

        .nav-arrow.disabled {
            cursor: default;
            opacity: 0.2;
        }

        .current-date {
            font-size: 16px;
            color: white;
        }

        .game-completion {
            display: none;
            text-align: center;
            background-color: #1a1a1a;
            padding: 20px;
            margin-top: 3px;
        }

        .game-completion .btn {
            margin: 2px 0;
            width: 95%;
        }

        .game-completion .btn:first-child {
            margin-top: 0;
        }

        .game-completion .btn:last-child {
            margin-bottom: 0;
        }

        .game-completion.finished h2,
        .game-completion.finished {
            display: block;
        }

        .completion-message {
            font-size: 20px;
            padding: 10px 0;
        }

        .about-content h2 {
            color: white;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .about-content p {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .about-content a {
            color: #2b82d4;
            text-decoration: none;
        }

        .about-content a:hover {
            color: #7eb4e7;
        }

        .support-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #3a3a3a;
        }

        .support-section h3 {
            color: white;
            margin-bottom: 15px;
        }

        .support-section p {
            margin-bottom: 15px;
        }

        .game-attempts #attempts-remaining.low-attempts,
        .game-attempts.low-attempts .attempts-label {
            color: orange;
        }

        .player-suggestion button:hover {
            background-color: #2a4d6e;
        }

        .cell.tier-common {
            border: 2px solid #808080;  /* Gray for common */
        }

        .cell.tier-rare {
            border: 2px solid #1e90ff;  /* Blue for rare */
        }

        .cell.tier-epic {
            border: 2px solid #9370db;  /* Purple for epic */
        }

        .cell.tier-first {
            border: 2px solid #ffd700;  /* Gold for first */
        }

        .cell.tier-first .tier-label {
            background-color: #ffd700;
            color: #000;
        }

        .cell .tier-label {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .cell.tier-common .tier-label {
            background-color: #808080;
            color: white;
        }

        .cell.tier-rare .tier-label {
            background-color: #1e90ff;
            color: white;
        }

        .cell.tier-epic .tier-label {
            background-color: #9370db;
            color: white;
        }

        /* Mobile styles */
        @media screen and (max-width: 480px) {
            .cell {
                font-size: 12px;
                min-height: 50px;
                padding: 8px;
            }

            .header-cell {
                font-size: 12px;
                padding: 10px;
            }

            .current-date {
                font-size: 14px;
            }

            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 2vh auto;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
                box-sizing: border-box;
                border-radius: 10px;
            }

            .close {
                top: 10px;
                right: 15px;
                font-size: 24px;
            }

            .player-suggestion {
                font-size: 12px;
                margin: 3px 0;
                padding: 6px;
            }

            .player-suggestion button {
                font-size: 12px;
                padding: 12px 6px;
            }

            #player-search {
                font-size: 12px;
                padding: 6px;
                margin: 5px 0;
            }

            .game-title-large,
            .game-attempts #attempts-remaining {
                font-size: 24px;
            }
            .game-subtitle {
                font-size: 10px;
            }

            .nav-arrow,
            .completion-message {
                font-size: 18px;
            }

            .help-button {
                width: 35px;
                height: 35px;
                font-size: 16px;
                top: 15px;
                right: 15px;
            }

            .help-content {
                width: 100%;
                max-width: 100%;
                padding: 20px;
                margin: 2vh auto;
                box-sizing: border-box;
            }
        }

        .game-completion .completion-count {
            color: #fff;
            font-size: 12px;
            margin: 10px 0;
        }

        .game-completion .completion-count span {
            font-weight: bold;
        }

        /* Header styles */
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            background-color: #1a1a1a;
            color: white;
            gap: 1rem;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .date-selector a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            background-color: #333;
            transition: background-color 0.3s;
        }

        .date-selector a:hover {
            background-color: #444;
        }

        .game-title {
            text-align: center;
            font-size: 20px;
            color: #888;
            margin: 10px 0;
            font-style: italic;
        }

        /* Footer styles */
        footer {
            background-color: #1a1a1a;
            color: white;
            padding: 1rem;
            text-align: center;
            margin-top: 20px;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .game-completion.finished {
            display: block;
        }

        /* Media query for larger screens */
        @media (min-width: 768px) {
            .header-content {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .date-selector {
                flex-wrap: nowrap;
            }
        }

        /* Filter details modal styles */
        #filterDetailsModal .modal-content {
            max-width: 600px;
            line-height: 1.6;
            padding: 20px;
        }
        
        #filterTitle {
            margin-top: 0;
            color: white;
            font-size: 18px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        #filterDescription {
            white-space: pre-line;
            font-size: 16px;
            margin: 0;
            padding: 0;
        }
        
        .last-updated {
            margin-top: 20px;
            font-size: 12px;
            color: #888;
            border-top: 1px solid #444;
            padding-top: 10px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            position: absolute;
            top: 15px;
            right: 20px;
            z-index: 1;
        }
        
        .close:hover {
            color: white;
        }

        /* Stats modal styles */
        .stats-container {
            margin: 20px 0;
        }

        .game-results-grid {
            margin: 20px 0;
            text-align: center;
        }

        .game-results-grid .btn-share {
            margin-top: 15px;
            width: auto;
            min-width: 150px;
        }

        .results-grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 200px;
            margin: 0 auto;
            background-color: #333;
            padding: 12px;
            border-radius: 8px;
        }

        .results-grid-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-color: #2a2a2a;
            border-radius: 4px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }

        .stat-item:first-child {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            padding: 15px 0;
        }

        .stat-item:first-child .stat-value {
            color: #4CAF50;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #888;
            font-size: 16px;
        }

        .stat-value {
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        /* Ranking styles */
        .ranking-container {
            margin: 20px 0;
            border-top: 1px solid #444;
            padding-top: 20px;
        }

        .ranking-title {
            color: white;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .ranking-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
            color: #888;
            border-radius: 4px;
            transition: all 0.3s ease;
            margin: 2px 0;
        }

        .ranking-entry.current-user {
            color: white;
            background-color: rgba(76, 175, 80, 0.15);
            padding: 8px 12px;
            font-weight: 500;
            border-left: 3px solid #4CAF50;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: highlightCurrentUser 0.5s ease-out;
        }

        @keyframes highlightCurrentUser {
            0% {
                background-color: rgba(76, 175, 80, 0.3);
                transform: translateX(-5px);
            }
            100% {
                background-color: rgba(76, 175, 80, 0.15);
                transform: translateX(0);
            }
        }

        .ranking-entry.current-user .ranking-rank,
        .ranking-entry.current-user .ranking-name,
        .ranking-entry.current-user .ranking-score {
            color: white;
            font-weight: 500;
        }

        .ranking-entry.current-user .ranking-rank {
            color: #4CAF50;
        }

        .ranking-name {
            flex-grow: 1;
            margin: 0 10px;
        }

        .ranking-score {
            font-weight: bold;
        }

        /* Stat animation styles */
        @keyframes statCountUp {
            0% {
                color: white;
                transform: translateY(10px);
                opacity: 0;
            }
            50% {
                color: #4CAF50;
            }
            100% {
                color: #4CAF50;
                transform: translateY(0);
                opacity: 1;
            }
        }

        .stat-animation {
            animation: statCountUp 0.8s ease-out 0.5s forwards;
        }

        @keyframes scoreCountUp {
            0% {
                color: white;
                transform: scale(1);
            }
            50% {
                color: #4CAF50;
                transform: scale(1.1);
            }
            100% {
                color: #4CAF50;
                transform: scale(1);
            }
        }

        .score-animation {
            animation: scoreCountUp 0.8s ease-out forwards;
        }

        .game-completion.finished {
            display: block;
        }

        /* Base button styles */
        .btn {
            width: 95%;
            padding: 0.75rem;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }

        /* Button variants */
        .btn-primary {
            background-color: #1d428a;
        }
        .btn-primary:hover {
            background-color: #2a4d6e;
        }

        .btn-secondary {
            background-color: #333;
        }
        .btn-secondary:hover {
            background-color: #444;
        }

        .btn-secondary:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        .btn-secondary:disabled:hover {
            background-color: #555;
        }

        /* Admin footer - always visible and toned down */
        .admin-footer {
            text-align: center;
            padding: 15px 20px;
            background-color: #1a1a1a;
        }
        
        .admin-separator {
            border: none;
            height: 1px;
            background-color: #666;
            margin: 0 0 15px 0;
        }
        
        .admin-link {
            color: #666;
            text-decoration: none;
            font-size: 14px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .admin-link:hover {
            color: #888;
            opacity: 0.9;
            text-decoration: underline;
        }
        
        .admin-separator-dot {
            color: #666;
            margin: 0 8px;
            opacity: 0.5;
        }

        /* Button spacing */
        .btn-mt {
            margin-top: 20px;
        }

        .stats-section-title {
            color: white;
            font-size: 18px;
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #444;
        }

        .display-name-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        #display-name-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #2a2a2a;
            color: white;
            font-size: 14px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
            white-space: nowrap;
        }

        #display-name-input:invalid {
            border-color: #ff4444;
        }

        .game-summary-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .game-summary-header h2 {
            margin-bottom: 10px;
        }

        .score-display {
            font-size: 18px;
        }

        .score-display .stat-label {
            color: #888;
            margin-right: 8px;
        }

        .score-display .stat-value {
            color: white;
            font-weight: bold;
        }
        
        /* Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>
    <main class="game-container {% if is_finished %}game-finished{% endif %}">
        <header class="game-header">
            <h1 class="game-title-large"><a href="{% url 'index' %}" style="color: white; text-decoration: none;">NBAGrid</a></h1>
            <nav class="date-navigation" aria-label="Date navigation">
                {% if show_prev %}
                <a href="{% url 'game' year=prev_date.year month=prev_date.month day=prev_date.day %}"
                    class="nav-arrow" aria-label="Previous date">‚Üê</a>
                {% else %}
                <span class="nav-arrow disabled" aria-label="No previous date available">‚Üê</span>
                {% endif %}
                <time class="current-date" datetime="{{ year }}-{{ month_num }}-{{ day }}">{{ month }} {{ day }}, {{ year }}</time>
                {% if show_next %}
                <a href="{% url 'game' year=next_date.year month=next_date.month day=next_date.day %}"
                    class="nav-arrow" aria-label="Next date">‚Üí</a>
                {% else %}
                <span class="nav-arrow disabled" aria-label="No next date available">‚Üí</span>
                {% endif %}
            </nav>
            <p class="game-subtitle">Click title to return Home</p>
            <button class="support-button" onclick="openSupportModal()" aria-label="Support">üíñ</button>
            <button class="help-button" onclick="openHelpModal()" aria-label="Help">?</button>
        </header>
        
        {% if game_title %}
        <h2 class="game-title">{{ game_title }}</h2>
        {% endif %}
        
        <section class="grid-container" aria-label="NBAGrid puzzle">
            <div class="cell game-title-cell">
                <div class="game-attempts {% if attempts_remaining <= 3 %}low-attempts{% endif %}">
                    <span class="attempts-label">Guesses:</span>
                    <span id="attempts-remaining">{{ attempts_remaining }}</span>
                </div>
                <div class="game-score">Score: {{ total_score|multiply:100|floatformat:0 }}</div>
            </div>
            {% for static_filter in static_filters %}
            <div class="cell header-cell header-col" onclick="showFilterDetails('static', {{ forloop.counter0 }})" role="button" tabindex="0" aria-label="Filter details for {{ static_filter }}">{{ static_filter }}</div>
            {% endfor %}

            {% for dynamic_filter in dynamic_filters %}
            <div class="cell header-cell header-row" onclick="showFilterDetails('dynamic', {{ forloop.counter0 }})" role="button" tabindex="0" aria-label="Filter details for {{ dynamic_filter }}">{{ dynamic_filter }}</div>
            {% for static_filter in static_filters %}
            {% with row=forloop.parentloop.counter0 col=forloop.counter0 %}
            {% with row_str=row|stringformat:"s" %}
            {% with col_str=col|stringformat:"s" %}
            {% with cell_key=row_str|add:"_"|add:col_str %}
            {% with cell_data_list=selected_cells|get_item:cell_key %}
            {% with cell_data=cell_data_list|get_correct_cell %}
            <div class="cell {% if cell_data and cell_data.is_correct %}correct tier-{{ cell_data.tier }}{% endif %} {% if is_finished and not cell_data.is_correct %}exhausted{% endif %}"
                onclick="{% if is_finished %}showCorrectPlayers(this){% elif not cell_data.is_correct %}openModal(this){% endif %}"
                data-row="{{ row }}" data-col="{{ col }}" {% if is_finished %}
                data-cell-key="{{ cell_key }}" {% endif %}
                role="button" tabindex="0" 
                aria-label="{% if cell_data and cell_data.is_correct %}Correct answer: {{ cell_data.player_name }}{% elif is_finished %}No correct answer found{% else %}Select player for {{ dynamic_filter }} and {{ static_filter }}{% endif %}">
                {% if cell_data_list %}
                {% with incorrect_guesses=cell_data_list|filter_incorrect|length %}
                {% if incorrect_guesses > 0 %}
                <span class="wrong-guesses" aria-label="{{ incorrect_guesses }} incorrect guesses">{{ incorrect_guesses }} X</span>
                {% endif %}
                {% endwith %}
                {% endif %}
                {% if cell_data and cell_data.is_correct and cell_data.player_name %}
                {{ cell_data.player_name }}
                <span class="tier-label">{{ cell_data.tier }}</span>
                {% elif is_finished and not cell_data.is_correct %}
                ?
                {% endif %}
            </div>
            {% endwith %}
            {% endwith %}
            {% endwith %}
            {% endwith %}
            {% endwith %}
            {% endwith %}
            {% endfor %}
            {% endfor %}
        </section>
        
        <footer class="game-completion {% if is_finished %}finished{% endif %}">
            <button class="btn btn-primary btn-share" onclick="shareResults()">Share Results</button>
            <button class="btn btn-primary" onclick="openStatsModal()">Stats</button>
            {% if unplayed_game_data.has_unplayed_games %}
            <button class="btn btn-secondary" onclick="playOlderGrid()">Play older Grid</button>
            {% else %}
            <button class="btn btn-secondary" disabled>All Grids Played...</button>
            {% endif %}
        </footer>
        
        <!-- Admin footer - always visible -->
        <footer class="admin-footer">
            <hr class="admin-separator">
            <a href="https://github.com/monsdar/nbagrid" target="_blank" rel="noopener noreferrer" class="admin-link">GitHub</a>
            <span class="admin-separator-dot">‚Ä¢</span>
            <a href="#" onclick="openAboutModal(); return false;" class="admin-link">About</a>
            {% if show_impressum %}
            <span class="admin-separator-dot">‚Ä¢</span>
            <a href="#" onclick="openImpressumModal(); return false;" class="admin-link">Impressum</a>
            {% endif %}
            <span class="admin-separator-dot">‚Ä¢</span>
            <a href="/admin/" class="admin-link">Admin</a>
        </footer>
    </main>

    <div id="playerModal" class="modal" role="dialog" aria-labelledby="playerModalTitle" aria-hidden="true">
        <div class="modal-content">
            <h2 id="playerModalTitle" class="sr-only">Select Player</h2>
            <input type="text" id="player-search" placeholder="Search for a player..." aria-label="Search for a player">
            <div id="player-suggestions" role="listbox" aria-label="Player suggestions"></div>
        </div>
    </div>

    <div id="correctPlayersModal" class="correct-players-modal" role="dialog" aria-labelledby="correctPlayersModalTitle" aria-hidden="true">
        <div class="correct-players-content">
            <h2 id="correctPlayersModalTitle">Correct Players</h2>
            <div id="correct-players-list"></div>
        </div>
    </div>

    <div id="aboutModal" class="about-modal" role="dialog" aria-labelledby="aboutModalTitle" aria-hidden="true">
        <div class="about-content">
            <span class="close" onclick="closeAboutModal()" aria-label="Close about modal">&times;</span>
            <h2 id="aboutModalTitle">About NBAGrid</h2>
            <p>NBAGrid is a daily puzzle game where you try to find NBA players that match specific criteria. Each day
                presents a new grid with different combinations of player attributes to guess.</p>
            <p>Created by <a href="https://nils.brink.men" target="_blank" rel="noopener">Nils Brinkmann</a>, this game is inspired by
                popular grid-based puzzle game <a href="https://www.geogridgame.com" target="_blank" rel="noopener">GeoGrid</a>.</p>
            <p>The code for this game is open source and available on <a href="https://github.com/monsdar/nbagrid"
                    target="_blank" rel="noopener">GitHub</a>.</p>
            <button class="btn btn-secondary" onclick="closeAboutModal()">Close</button>
        </div>
    </div>

    <div id="supportModal" class="about-modal" role="dialog" aria-labelledby="supportModalTitle" aria-hidden="true">
        <div class="about-content">
            <span class="close" onclick="closeSupportModal()" aria-label="Close support modal">&times;</span>
            <h2 id="supportModalTitle">Support NBAGrid</h2>
            <div class="support-section">
                <p>Thanks for enjoying my game! It's a passion project and I'm happy to see you here.</p>
                <p>While hosting this service isn't extremely expensive, it's not free either.
                    There's no company behind this, and I'd like to keep any ads out of it. So if you enjoy playing
                    NBAGrid and would like to support its development and maintenance, please consider buying me a coffee.</p>
                <p>Feedback is always welcome. Feel free to suggest filters, grids,
                    or general ideas within your coffee-message or use the <a href="https://github.com/monsdar/nbagrid/issues" target="_blank" rel="noopener">GitHub issue tracker</a>.</p>
                <a href="https://buymeacoffee.com/monsdar" target="_blank" rel="noopener" class="btn btn-primary" style="color: white;">‚òï Buy Me a Coffee ‚òï</a>
            </div>
        </div>
    </div>

    <div id="filterDetailsModal" class="modal" role="dialog" aria-labelledby="filterDetailsModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close" onclick="closeFilterDetailsModal()" aria-label="Close filter details modal">&times;</span>
            <h2 id="filterDetailsModalTitle">Filter Details</h2>
            <p id="filterDescription"></p>
            <div class="last-updated">Player data last updated: {{ last_updated_date }}</div>
        </div>
    </div>

    <div id="statsModal" class="modal" role="dialog" aria-labelledby="statsModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close" onclick="closeStatsModal()" aria-label="Close stats modal">&times;</span>
            <div class="game-summary-header">
                <h2 id="statsModalTitle">Game Summary</h2>
                <div class="score-display">
                    <span class="stat-label">Score:</span>
                    <span class="stat-value score-value">{{ total_score|multiply:100|floatformat:0 }}</span>
                </div>
            </div>
            
            <!-- Game Results Grid -->
            <div class="game-results-grid">
                <div class="results-grid-container"></div>
                <button class="btn btn-primary btn-share" onclick="shareResults()">Share Results</button>
            </div>
            
            <!-- Section 1: Today's Game -->
            <div class="stats-container">
                <h3 class="stats-section-title">Today's Game</h3>
                <div class="stat-item">
                    <span class="stat-label">Your Score:</span>
                    <span class="stat-value score-value">{{ total_score|multiply:100|floatformat:0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Completions:</span>
                    <span class="stat-value" id="total-completions">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Perfect Completions:</span>
                    <span class="stat-value" id="perfect-games">-</span>
                </div>
            </div>

            <!-- Section 2: Ranking -->
            <div class="ranking-container">
                <h3 class="stats-section-title">Ranking</h3>
                <div id="ranking-list"></div>
            </div>

            <!-- Section 3: Player Stats -->
            <div class="stats-container">
                <h3 class="stats-section-title">Player Stats</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Completions:</span>
                    <span class="stat-value" id="player-total-completions">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Perfect Completions:</span>
                    <span class="stat-value" id="player-perfect-completions">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Completion Streak:</span>
                    <span class="stat-value" id="current-streak">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Perfect Streak:</span>
                    <span class="stat-value" id="perfect-streak">-</span>
                </div>
            </div>


            <!-- Display Name Section -->
            <div class="stats-container">
                <h3 class="stats-section-title">Settings</h3>
                <div class="display-name-container">
                    <input type="text" id="display-name-input" maxlength="14" value="{{ user_data.display_name }}" 
                           pattern="[a-zA-Z0-9\s]+" title="Only letters, numbers and spaces allowed">
                    <button class="btn btn-secondary btn-sm" onclick="generateRandomName()">üé≤</button>
                    <button class="btn btn-primary btn-sm" onclick="updateDisplayName()">‚úì</button>
                </div>
            </div>
            
            <button class="btn btn-secondary btn-mt" onclick="closeStatsModal()">Close</button>
        </div>
    </div>

    <div id="helpModal" class="help-modal" role="dialog" aria-labelledby="helpModalTitle" aria-hidden="true">
        <div class="help-content">
            <span class="close" onclick="closeHelpModal()" aria-label="Close help modal">&times;</span>
            <h2 id="helpModalTitle">Welcome to NBAGrid!</h2>
            <p>NBAGrid is a daily puzzle game where you try to find NBA players that match specific criteria. Each day
                presents a new grid with different combinations of player attributes to guess.</p>
            <h2 id="helpModalTitle">How to Play</h2>
            <p>The goal is to guess as many cells as possible. The more cells you guess correctly, and the rarer the players you pick, the higher your score!</p>
            <p>The grid presents a number of categories that apply to a number of NBA players. You need to find the players that match both categories that apply to the empty cell.</p>
            <p>Categories include:</p>
            <ul>
                <li>Position (Guard, Forward, Center)</li>
                <li>Awards like NBA Champions, All-Stars All-NBA teams, ...</li>
                <li>Team (e.g., Lakers, Warriors, Bulls)</li>
                <li>Number of seasons played</li>
                <li>Average and Career High stats</li>
            </ul>
            <p>The game only shows players that are currently active in the NBA.</p>
            <p>Click on a category to get help what is searched for in that category.</p>
            <button class="btn btn-primary" onclick="closeHelpModal()">Let's Go!</button>
        </div>
    </div>

    <div id="impressumModal" class="about-modal" role="dialog" aria-labelledby="impressumModalTitle" aria-hidden="true">
        <div class="about-content">
            <h2 id="impressumModalTitle">Impressum</h2>
            <div id="impressumContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <button class="btn btn-primary" onclick="closeImpressumModal()">Close</button>
        </div>
    </div>

    {% if is_finished %}
    {{ correct_players|json_script:"correct-players-data" }}
    {% endif %}

    <script>
        let currentCell = null;
        const modal = document.getElementById('playerModal');
        const searchInput = document.getElementById('player-search');
        const suggestionsDiv = document.getElementById('player-suggestions');
        let cell_players = new Set();

        // Filter details modal functions
        function showFilterDetails(filterType, index) {
            const modal = document.getElementById('filterDetailsModal');
            const title = document.getElementById('filterDetailsModalTitle');
            const description = document.getElementById('filterDescription');
            
            let filterText = '';
            let detailedDescription = '';
            
            // Get the filter values from pre-generated JSON
            const staticFilters = {{ static_filters|to_json|safe }};
            const staticFiltersDetailed = {{ static_filters_detailed|to_json|safe }};
            const dynamicFilters = {{ dynamic_filters|to_json|safe }};
            const dynamicFiltersDetailed = {{ dynamic_filters_detailed|to_json|safe }};
            
            if (filterType === 'static' && index < staticFilters.length) {
                filterText = staticFilters[index];
                detailedDescription = staticFiltersDetailed[index];
            } else if (filterType === 'dynamic' && index < dynamicFilters.length) {
                filterText = dynamicFilters[index];
                detailedDescription = dynamicFiltersDetailed[index];
            }
            
            title.textContent = filterText;
            description.textContent = detailedDescription;
            
            modal.style.display = 'block';
        }
        
        function closeFilterDetailsModal() {
            document.getElementById('filterDetailsModal').style.display = 'none';
            // Ensure input is cleared when filter details modal is closed
            clearPlayerSearchInput();
        }

        function openModal(cell) {
            if (cell.classList.contains('correct') || cell.classList.contains('exhausted')) return;
            currentCell = cell;
            // Clear the input field when opening the modal
            clearPlayerSearchInput();
            modal.style.display = 'block';
            searchInput.focus();
        }

        function closeModal() {
            modal.style.display = 'none';
            currentCell = null;
            searchInput.value = '';
            suggestionsDiv.innerHTML = '';
        }

        // Additional function to ensure input is cleared in all scenarios
        function clearPlayerSearchInput() {
            if (searchInput) {
                searchInput.value = '';
            }
            if (suggestionsDiv) {
                suggestionsDiv.innerHTML = '';
            }
        }

        function showCorrectPlayers(cell) {
            const cellKey = cell.getAttribute('data-cell-key');
            const correctPlayersDataElement = document.getElementById('correct-players-data');
            
            // If the correct-players-data element doesn't exist, create it
            if (!correctPlayersDataElement) {
                console.log('correct-players-data element not found, creating empty data');
                const correctPlayersScript = document.createElement('script');
                correctPlayersScript.id = 'correct-players-data';
                correctPlayersScript.type = 'application/json';
                correctPlayersScript.textContent = JSON.stringify({});
                document.body.appendChild(correctPlayersScript);
            }
            
            const correctPlayersData = JSON.parse(document.getElementById('correct-players-data').textContent);
            const players = correctPlayersData[cellKey] || [];
            const dialog = document.getElementById('correctPlayersModal');
            const content = document.getElementById('correct-players-list');
            
            if (!players || players.length === 0) {
                content.innerHTML = '<p>No players found for this cell.</p>';
            } else {
                let html = '';
                
                // Sort players to show wrong guesses first
                const sortedPlayers = [...players].sort((a, b) => {
                    if (a.is_wrong_guess && !b.is_wrong_guess) return -1;
                    if (!a.is_wrong_guess && b.is_wrong_guess) return 1;
                    return 0;
                });
                
                sortedPlayers.forEach(function(player) {
                    const wrongGuessClass = player.is_wrong_guess ? 'wrong-guess' : '';
                    const wrongGuessCount = player.is_wrong_guess ? '<span class="wrong-guess-count">1 X</span>' : '';
                    html += `<div class="correct-player ${wrongGuessClass}">
                        ${wrongGuessCount}
                        <div class="player-name">${player.name}</div>
                        <div class="player-stats">${player.stats.join('<br>')}</div>
                    </div>`;
                });
                
                content.innerHTML = html;
            }
            
            // Update the dialog title with the count of non-wrong-guess players
            const title = dialog.querySelector('h2');
            const validPlayers = players ? players.filter(p => !p.is_wrong_guess) : [];
            title.textContent = `Possible Players: ${validPlayers.length}`;
            
            dialog.style.display = 'block';
        }

        function closeCorrectPlayersModal() {
            document.getElementById('correctPlayersModal').style.display = 'none';
            // Ensure input is cleared when correct players modal is closed
            clearPlayerSearchInput();
        }

        function updateAttemptsCounter(attempts) {
            const counter = document.getElementById('attempts-remaining');
            counter.textContent = attempts;
            if (attempts <= 3) {
                counter.classList.add('low-attempts');
            } else {
                counter.classList.remove('low-attempts');
            }
        }

        // Initialize selected players from the game state
        console.log('Initializing cell_players from game state:');
        {% for cell_key, cell_data_list in selected_cells.items %}
            {% for cell_data in cell_data_list %}
                {% if cell_data.is_correct %}
                    console.log('Cell key: {{ cell_key }}, Cell data: {{ cell_data }}');
                    cell_players.add('{{ cell_data.player_id }}');
                {% endif %}
            {% endfor %}
        {% endfor %}
        console.log('Final cell_players Set:', Array.from(cell_players));

        // Initialize attempts counter
        updateAttemptsCounter({{ attempts_remaining }});

        function selectPlayer(playerId, playerName) {
            if (!currentCell) return;
            console.log('Attempting to select player:', playerId);
            console.log('Current cell_players:', Array.from(cell_players));
            if (cell_players.has(playerId.toString())) {
                console.log('Player already selected, preventing selection');
                // Update all buttons for this player to be disabled
                document.querySelectorAll(`button[data-player-id="${playerId}"]`).forEach(button => {
                    button.disabled = true;
                    button.textContent = 'Selected';
                });
                return;
            }

            const row = currentCell.getAttribute('data-row');
            const col = currentCell.getAttribute('data-col');
            const formData = new FormData();
            formData.append('player_id', playerId);
            formData.append('row', row);
            formData.append('col', col);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            // Disable the button immediately to prevent double-clicks
            const button = document.querySelector(`button[data-player-id="${playerId}"]`);
            if (button) {
                button.disabled = true;
                button.textContent = 'Selected';
            }
            
            // Disable all other buttons with the same player ID
            document.querySelectorAll(`button[data-player-id="${playerId}"]`).forEach(btn => {
                if (btn !== button) {
                    btn.disabled = true;
                    btn.textContent = 'Selected';
                }
            });

            fetch('/{{ year }}/{{ month_num }}/{{ day }}/', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    // Store the server response for refreshStats to use
                    window.lastServerResponse = data;
                    
                    if (data.error) {
                        // Re-enable the button if there was an error
                        document.querySelectorAll(`button[data-player-id="${playerId}"]`).forEach(btn => {
                            btn.disabled = false;
                            btn.textContent = 'Select';
                        });
                        return;
                    }

                    if (data.is_correct) {
                        // Add to the set of selected players only if the guess was correct
                        cell_players.add(playerId.toString());
                        
                        // Clear the cell content
                        currentCell.textContent = '';
                        
                        // Find the correct CellData
                        const correctCellData = data.cell_data.find(cell => cell.is_correct);
                        if (!correctCellData) {
                            console.error('No correct cell data found');
                            return;
                        }
                        
                        // Add the player name
                        const playerNameSpan = document.createElement('span');
                        playerNameSpan.textContent = playerName;
                        currentCell.appendChild(playerNameSpan);
                        
                        // Add tier label
                        const tierLabel = document.createElement('span');
                        tierLabel.className = 'tier-label';
                        tierLabel.textContent = correctCellData.tier;
                        currentCell.appendChild(tierLabel);
                        
                        // Add wrong guesses count if there are any
                        const incorrectGuesses = data.cell_data.filter(cell => !cell.is_correct).length;
                        if (incorrectGuesses > 0) {
                            const wrongGuessesSpan = document.createElement('span');
                            wrongGuessesSpan.className = 'wrong-guesses';
                            wrongGuessesSpan.textContent = incorrectGuesses + ' X';
                            currentCell.appendChild(wrongGuessesSpan);
                        }
                        
                        currentCell.classList.add('correct');
                        currentCell.classList.add(`tier-${correctCellData.tier}`);
                    } else {
                        currentCell.textContent = "";
                        currentCell.classList.add('flash-red');
                        
                        // Update wrong guesses count
                        // Count incorrect guesses from cell data list
                        const incorrectGuesses = data.cell_data.filter(cell => !cell.is_correct).length;
                        if (incorrectGuesses > 0) {
                            const wrongGuessesSpan = document.createElement('span');
                            wrongGuessesSpan.className = 'wrong-guesses';
                            wrongGuessesSpan.textContent = incorrectGuesses + ' X';
                            currentCell.appendChild(wrongGuessesSpan);
                        }
                    }

                    // Update score display if total_score is available
                    if (data.total_score !== undefined) {
                        const scoreElement = document.querySelector('.game-title-cell .game-score');
                        if (scoreElement) {
                            const score = (data.total_score * 100).toFixed(0);
                            scoreElement.textContent = 'Score: ' + score;
                        }
                        const statsScoreElement = document.querySelector('#statsModal .stat-item:first-child .stat-value');
                        if (statsScoreElement) {
                            statsScoreElement.textContent = (data.total_score * 100).toFixed(0);
                        }
                    }

                    updateAttemptsCounter(data.attempts_remaining);

                    // Handle finished game
                    if (data.is_finished) {
                        // Add finished class to show completion message and share button
                        document.querySelector('.game-completion').classList.add('finished');
                        
                        // Add game-finished class to the game container for hover effects
                        document.querySelector('.game-container').classList.add('game-finished');

                        // Create and add the correct players data script element
                        const correctPlayersScript = document.createElement('script');
                        correctPlayersScript.id = 'correct-players-data';
                        correctPlayersScript.type = 'application/json';
                        correctPlayersScript.textContent = JSON.stringify(data.cell_players);
                        document.body.appendChild(correctPlayersScript);

                        // Mark all cells as either correct or exhausted
                        document.querySelectorAll('.cell:not(.header-cell):not(.game-title-cell)').forEach(cell => {
                            const row = cell.getAttribute('data-row');
                            const col = cell.getAttribute('data-col');
                            const cellKey = `${row}_${col}`;
                            
                            // Check if this cell has a correct guess in the current data
                            const cellData = data.selected_cells[cellKey];
                            const hasCorrectGuess = cellData && cellData.some(cell => cell.is_correct);
                            
                            // Set the data-cell-key attribute for all cells
                            cell.setAttribute('data-cell-key', cellKey);
                            
                            if (!hasCorrectGuess) {
                                // Keep the wrong guesses count if it exists
                                const wrongGuesses = cell.querySelector('.wrong-guesses');
                                cell.textContent = '?';
                                if (wrongGuesses) {
                                    cell.insertBefore(wrongGuesses, cell.firstChild);
                                }
                                cell.classList.add('exhausted');
                            }
                            
                            // Set onclick handler for all cells
                            cell.onclick = function () { showCorrectPlayers(this); };
                        });

                        // Update the "Play older Grid" button with new unplayed game data
                        if (data.unplayed_game_data) {
                            updatePlayOlderGridButton(data.unplayed_game_data);
                        }

                        // Close the player selection modal if it's open
                        closeModal();
                        
                        // Ensure input is cleared
                        clearPlayerSearchInput();
                        
                        // Show stats dialog with the updated data
                        openStatsModal();

                    }
                    closeModal();
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Re-enable the button if there was an error
                    document.querySelectorAll(`button[data-player-id="${playerId}"]`).forEach(btn => {
                        btn.disabled = false;
                        btn.textContent = 'Select';
                    });
                });
        }

        // Close modals when clicking outside
        window.onclick = function (event) {
            if (event.target == document.getElementById('playerModal')) {
                closeModal();
            }
            if (event.target == document.getElementById('correctPlayersModal')) {
                closeCorrectPlayersModal();
            }
            if (event.target == document.getElementById('aboutModal')) {
                closeAboutModal();
            }
            if (event.target == document.getElementById('supportModal')) {
                closeSupportModal();
            }
            if (event.target == document.getElementById('filterDetailsModal')) {
                closeFilterDetailsModal();
            }
            if (event.target == document.getElementById('statsModal')) {
                closeStatsModal();
            }
            if (event.target == document.getElementById('helpModal')) {
                closeHelpModal();
            }
            if (event.target == document.getElementById('impressumModal')) {
                closeImpressumModal();
            }
        }

        // Function to update player suggestion buttons based on selected players
        function updatePlayerSelectionButtons() {
            document.querySelectorAll('.player-suggestion button').forEach(button => {
                const playerId = button.getAttribute('data-player-id');
                if (playerId && cell_players.has(playerId.toString())) {
                    button.disabled = true;
                    button.textContent = 'Selected';
                }
            });
        }

        searchInput.addEventListener('input', function () {
            const query = this.value;
            if (query.length < 3) {
                suggestionsDiv.innerHTML = '';
                return;
            }

            fetch(`/search-players/?name=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(players => {
                    suggestionsDiv.innerHTML = '';
                    players.forEach(player => {
                        const div = document.createElement('div');
                        div.className = 'player-suggestion';
                        // Check the current state of cell_players
                        const isSelected = cell_players.has(player.stats_id.toString());
                        console.log('Rendering player:', player.name, 'isSelected:', isSelected, 'stats_id:', player.stats_id, 'cell_players:', Array.from(cell_players));
                        const escapedName = player.name.replace(/'/g, "\\'");
                        const button = document.createElement('button');
                        button.textContent = isSelected ? 'Selected' : 'Select';
                        button.disabled = isSelected;
                        button.setAttribute('data-player-id', player.stats_id);
                        button.onclick = function() {
                            console.log('Button clicked for player:', player.name, 'stats_id:', player.stats_id, 'isSelected:', cell_players.has(player.stats_id.toString()));
                            selectPlayer(player.stats_id, escapedName);
                        };
                        div.appendChild(document.createTextNode(player.name));
                        div.appendChild(button);
                        suggestionsDiv.appendChild(div);
                    });
                    
                    // Update button states based on selected players
                    updatePlayerSelectionButtons();
                });
        });

        function shareResults() {
            const grid = document.querySelectorAll('.cell:not(.header-cell):not(.game-title-cell)');
            let result = 'üèÄ NBAGrid üèÄ\n';
            result += '{{ month }} {{ day }}, {{ year }}\n\n';

            // Add the grid results using tier-specific emojis
            for (let i = 0; i < grid.length; i++) {
                const cell = grid[i];
                if (cell.classList.contains('correct')) {
                    if (cell.classList.contains('tier-first')) {
                        result += 'ü¶Ñ';  // Unicorn for first
                    } else if (cell.classList.contains('tier-epic')) {
                        result += 'üëë';  // Crown for epic
                    } else {
                        result += '‚úÖ';  // Check mark for common and rare tiers
                    }
                } else {
                    result += '‚ùå';  // X mark for incorrect
                }
                if ((i + 1) % 3 === 0) {
                    result += '\n';
                }
            }

            // Get the score from the .game-score element
            const scoreElement = document.querySelector('.game-title-cell .game-score');
            const score = scoreElement ? scoreElement.textContent.replace('Score: ', '') : '-';
            result += '\nScore: ' + score;

            // Get streak information
            const streakElement = document.getElementById('current-streak');
            const streak = streakElement ? streakElement.textContent : '-';
            result += '\nStreak: ' + streak;

            // Get rank information
            const currentUserRank = document.querySelector('.ranking-entry.current-user .ranking-rank');
            const totalCompletions = document.getElementById('total-completions');
            const rank = currentUserRank ? currentUserRank.textContent.replace('.', '') : '-';
            const total = totalCompletions ? totalCompletions.textContent : '-';
            result += '\nRank: ' + rank + ' of ' + total;

            result += '\nPlay at: {{ request.scheme }}://{{ request.get_host }}{% url "game" year=year month=month_num day=day %}';

            // Copy to clipboard
            navigator.clipboard.writeText(result).then(() => {
                // Show a brief notification that the results were copied
                const buttons = document.querySelectorAll('.btn-share');
                buttons.forEach(button => {
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                });
            }).catch(err => {
                console.error('Failed to copy results: ', err);
            });
        }

        function openAboutModal() {
            document.getElementById('aboutModal').style.display = 'block';
        }

        function openSupportModal() {
            document.getElementById('supportModal').style.display = 'block';
        }

        function closeAboutModal() {
            document.getElementById('aboutModal').style.display = 'none';
            // Ensure input is cleared when about modal is closed
            clearPlayerSearchInput();
        }

        function closeSupportModal() {
            document.getElementById('supportModal').style.display = 'none';
            // Ensure input is cleared when support modal is closed
            clearPlayerSearchInput();
        }

        function openStatsModal() {
            const modal = document.getElementById('statsModal');
            modal.style.display = 'block';
            // Use requestAnimationFrame to ensure the modal is visible before updating stats
            requestAnimationFrame(() => {
                refreshStats();
            });
        }

        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
            // Ensure input is cleared when stats modal is closed
            clearPlayerSearchInput();
        }

        function openImpressumModal() {
            document.getElementById('impressumModal').style.display = 'block';
            // Load impressum content dynamically
            loadImpressumContent();
        }

        function closeImpressumModal() {
            document.getElementById('impressumModal').style.display = 'none';
            // Ensure input is cleared when impressum modal is closed
            clearPlayerSearchInput();
        }

        function loadImpressumContent() {
            fetch('/api/impressum')
                .then(response => response.json())
                .then(data => {
                    const contentDiv = document.getElementById('impressumContent');
                    if (data.length === 0) {
                        contentDiv.innerHTML = `
                            <div class="impressum-section">
                                <h3>Impressum Configuration</h3>
                                <div class="impressum-text">
                                    No impressum content has been configured yet.<br><br>
                                    To add impressum content, an administrator can add entries through the admin interface at <a href="/admin/" target="_blank" style="color: #4a9eff;">/admin/</a> under "Impressum Content".
                                </div>
                            </div>
                        `;
                    } else {
                        let html = '';
                        data.forEach(item => {
                            html += `<div class="impressum-section">`;
                            html += `<h3>${escapeHtml(item.title)}</h3>`;
                            html += `<div class="impressum-text">${escapeHtml(item.content).replace(/\n/g, '<br>')}</div>`;
                            html += `</div>`;
                        });
                        contentDiv.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error loading impressum content:', error);
                    document.getElementById('impressumContent').innerHTML = `
                        <div class="impressum-section">
                            <h3>Error</h3>
                            <div class="impressum-text">
                                Error loading impressum content. Please try again later.
                            </div>
                        </div>
                    `;
                });
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function refreshStats() {
            console.log('Refreshing stats...');
            
            // Get data from the server response if available
            const data = window.lastServerResponse || {
                completion_count: {{ completion_count|default:"0" }},
                total_score: {{ total_score|default:"0" }},
                perfect_games: {{ perfect_games|default:"0" }},
                streak: {{ streak|default:"0" }},
                streak_rank: {% if streak_rank %}{{ streak_rank|to_json|safe }}{% else %}null{% endif %},
                ranking_data: {% if ranking_data %}{{ ranking_data|to_json|safe }}{% else %}[]{% endif %},
                player_stats: {% if player_stats %}{{ player_stats|to_json|safe }}{% else %}{}{% endif %}
            };
            
            // Update the results grid
            const gridContainer = document.querySelector('.results-grid-container');
            if (gridContainer) {
                gridContainer.innerHTML = '';
                const cells = document.querySelectorAll('.cell:not(.header-cell):not(.game-title-cell)');
                cells.forEach(cell => {
                    const gridCell = document.createElement('div');
                    gridCell.className = 'results-grid-cell';
                    
                    if (cell.classList.contains('correct')) {
                        if (cell.classList.contains('tier-first')) {
                            gridCell.textContent = 'ü¶Ñ';  // Unicorn for first
                        } else if (cell.classList.contains('tier-epic')) {
                            gridCell.textContent = 'üëë';  // Crown for epic
                        } else {
                            gridCell.textContent = '‚úÖ';  // Check mark for common and rare tiers
                        }
                    } else {
                        gridCell.textContent = '‚ùå';  // X mark for incorrect
                    }
                    gridContainer.appendChild(gridCell);
                });
            }
            
            // Get all stat elements
            const elements = {
                score: document.querySelector('.score-value'),
                totalCompletions: document.getElementById('total-completions'),
                perfectGames: document.getElementById('perfect-games'),
                playerTotalCompletions: document.getElementById('player-total-completions'),
                playerPerfectCompletions: document.getElementById('player-perfect-completions'),
                currentStreak: document.getElementById('current-streak'),
                perfectStreak: document.getElementById('perfect-streak')
            };

            console.log('Score element:', elements.score); // Debug log

            // Function to animate stat changes
            function animateStat(element, newValue, oldValue) {
                if (!element) return;
                if (newValue > oldValue) {
                    element.classList.remove('stat-animation');
                    void element.offsetWidth;
                    element.classList.add('stat-animation');
                    element.textContent = oldValue;
                    setTimeout(() => {
                        element.textContent = newValue;
                    }, 500);
                } else {
                    element.textContent = newValue;
                }
            }

            // Update score if element exists
            const scoreElements = document.querySelectorAll('.score-value');
            if (scoreElements.length > 0) {
                const finalScore = (data.total_score * 100).toFixed(0);
                let currentScore = 0;
                const duration = 800; // 800ms
                const steps = 20; // 20 steps
                const increment = finalScore / steps;
                const stepDuration = duration / steps;

                function updateScore() {
                    if (currentScore < finalScore) {
                        currentScore = Math.min(currentScore + increment, finalScore);
                        scoreElements.forEach(element => {
                            element.textContent = Math.round(currentScore);
                        });
                        setTimeout(updateScore, stepDuration);
                    } else {
                        scoreElements.forEach(element => {
                            element.textContent = finalScore;
                        });
                    }
                }

                // Reset and start the animation for all score elements
                scoreElements.forEach(element => {
                    element.style.animation = 'none';
                    element.offsetHeight; // Force reflow
                    element.style.animation = null;
                    element.classList.remove('score-animation');
                    void element.offsetWidth; // Force reflow
                    element.classList.add('score-animation');
                });
                updateScore();
            } else {
                console.error('Score elements not found in stats modal');
            }

            // Update Today's Game stats
            if (data.completion_count !== undefined) {
                if (data.completion_count >= 1) {
                    animateStat(elements.totalCompletions, data.completion_count, data.completion_count - 1);
                } else {
                    elements.totalCompletions.textContent = data.completion_count;
                }
            }
            if (data.perfect_games !== undefined) {
                if (data.perfect_games >= 1) {
                    animateStat(elements.perfectGames, data.perfect_games, data.perfect_games - 1);
                } else {
                    elements.perfectGames.textContent = data.perfect_games;
                }
            }

            // Update Player Stats
            const playerStats = data.player_stats || {};
            if (playerStats.total_completions !== undefined) {
                if (playerStats.total_completions >= 1) {
                    animateStat(elements.playerTotalCompletions, playerStats.total_completions, (playerStats.total_completions || 0) - 1);
                } else {
                    elements.playerTotalCompletions.textContent = playerStats.total_completions;
                }
            }
            if (playerStats.perfect_completions !== undefined) {
                if (playerStats.perfect_completions >= 1) {
                    animateStat(elements.playerPerfectCompletions, playerStats.perfect_completions, (playerStats.perfect_completions || 0) - 1);
                } else {
                    elements.playerPerfectCompletions.textContent = playerStats.perfect_completions;
                }
            }
            
            // Format streak display
            let streakDisplay = "-";
            let oldStreakDisplay = "-";
            if (data.streak > 0) {
                streakDisplay = `${data.streak} days`;
                oldStreakDisplay = `${data.streak-1} days`;
            }
            animateStat(elements.currentStreak, streakDisplay, oldStreakDisplay);

            // Format perfect streak display
            let perfectStreakDisplay = "-";
            let oldPerfectStreakDisplay = "-";
            if (playerStats.perfect_streak > 0) {
                perfectStreakDisplay = `${playerStats.perfect_streak} days`;
                oldPerfectStreakDisplay = `${playerStats.perfect_streak-1} days`;
            }
            if (elements.perfectStreak) {
                animateStat(elements.perfectStreak, perfectStreakDisplay, oldPerfectStreakDisplay);
            }
            
            // Update ranking
            const rankingList = document.getElementById('ranking-list');
            const rankingData = data.ranking_data || [];
            
            if (rankingList) {
                if (rankingData.length > 0) {
                    let rankingHtml = '';
                    const currentUserDisplayName = '{{ user_data.display_name }}';
                    
                    rankingData.forEach(function(entry) {
                        const rank = entry[0];
                        const name = entry[1];
                        const score = entry[2];
                        const isCurrentUser = name === currentUserDisplayName;
                        
                        const entryClass = isCurrentUser ? 'ranking-entry current-user' : 'ranking-entry';
                        const formattedScore = (score * 100).toFixed(0);
                        rankingHtml += 
                            '<div class="' + entryClass + '">' +
                            '<span class="ranking-rank">' + rank + '.</span>' +
                            '<span class="ranking-name">' + name + '</span>' +
                            '<span class="ranking-score">' + formattedScore + '</span>' +
                            '</div>';
                    });
                    rankingList.innerHTML = rankingHtml;
                } else {
                    rankingList.innerHTML = '<div class="ranking-entry">No ranking data available</div>';
                }
            }
        }

        // Function to toggle subtitle visibility
        function toggleSubtitle(show) {
            const subtitle = document.querySelector('.game-subtitle');
            if (subtitle) {
                subtitle.style.display = show ? 'block' : 'none';
            }
        }

        // Add click handlers to date navigation arrows
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure player search input is cleared on page load
            clearPlayerSearchInput();
            
            const prevArrow = document.querySelector('.nav-arrow:not(.disabled)');
            const nextArrow = document.querySelector('.nav-arrow:not(.disabled)');
            
            if (prevArrow) {
                prevArrow.addEventListener('click', function(e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    if (href) {
                        window.location.href = href;
                    }
                });
            }
            
            if (nextArrow) {
                nextArrow.addEventListener('click', function(e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    if (href) {
                        window.location.href = href;
                    }
                });
            }

            // Initial subtitle state
            const isSpecificDate = window.location.pathname.match(/\/\d+\/\d+\/\d+\/$/);
            console.log('Initial subtitle state:', isSpecificDate);
            toggleSubtitle(isSpecificDate);

            // Show help modal for first-time users
            const hasSeenHelp = localStorage.getItem('nbagrid_help_seen');
            if (!hasSeenHelp) {
                // Small delay to ensure the page is fully loaded
                setTimeout(() => {
                    openHelpModal();
                }, 500);
            }
        });

        function generateRandomName() {
            fetch('/api/random-name/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('display-name-input').value = data.name;
                })
                .catch(error => {
                    console.error('Error generating random name:', error);
                });
        }

        function updateDisplayName() {
            const input = document.getElementById('display-name-input');
            const newName = input.value.trim();
            
            // Validate the name
            if (!newName.match(/^[a-zA-Z0-9\s]+$/)) {
                alert('Name can only contain letters, numbers and spaces');
                return;
            }
            
            if (newName.length < 6) {
                alert('Name must be at least 6 characters long');
                return;
            }
            
            if (newName.length > 14) {
                alert('Name must be 14 characters or less');
                return;
            }

            fetch('/api/update-display-name/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ display_name: newName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the name in the ranking list if it exists
                    const currentUserEntry = document.querySelector('.ranking-entry.current-user .ranking-name');
                    if (currentUserEntry) {
                        currentUserEntry.textContent = newName;
                    }
                } else {
                    alert('Failed to update name: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error updating display name:', error);
                alert('Failed to update name. Please try again.');
            });
        }

        function openHelpModal() {
            document.getElementById('helpModal').style.display = 'block';
        }

        function resetHelpModal() {
            localStorage.removeItem('nbagrid_help_seen');
            openHelpModal();
        }

        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
            // Mark that the user has seen the help modal
            localStorage.setItem('nbagrid_help_seen', 'true');
            // Ensure input is cleared when help modal is closed
            clearPlayerSearchInput();
        }

        function playOlderGrid() {
            {% if unplayed_game_data.has_unplayed_games %}
            const unplayedDate = '{{ unplayed_game_data.unplayed_date_str }}';
            if (unplayedDate) {
                const [year, month, day] = unplayedDate.split('-');
                window.location.href = `/${year}/${month}/${day}/`;
            }
            {% endif %}
        }

        function updatePlayOlderGridButton(unplayedGameData) {
            // Find the "Play older Grid" button in the footer
            const footer = document.querySelector('.game-completion');
            if (!footer) return;
            
            // Find the button (it should be the third button in the footer)
            const buttons = footer.querySelectorAll('.btn');
            let playOlderButton = null;
            
            // Look for the "Play older Grid" button
            for (let button of buttons) {
                if (button.textContent.includes('Play older Grid') || button.textContent.includes('All Grids Played')) {
                    playOlderButton = button;
                    break;
                }
            }
            
            if (playOlderButton) {
                if (unplayedGameData.has_unplayed_games) {
                    // Update button to be enabled and point to the new unplayed game
                    playOlderButton.textContent = 'Play older Grid';
                    playOlderButton.disabled = false;
                    playOlderButton.onclick = function() {
                        const [year, month, day] = unplayedGameData.unplayed_date_str.split('-');
                        window.location.href = `/${year}/${month}/${day}/`;
                    };
                } else {
                    // Update button to show "All Grids Played..."
                    playOlderButton.textContent = 'All Grids Played...';
                    playOlderButton.disabled = true;
                    playOlderButton.onclick = null;
                }
            }
        }
    </script>
</body>

</html>